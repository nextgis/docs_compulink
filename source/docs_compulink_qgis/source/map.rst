
.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _ngqgis_map:


Создание карты
===============

Добавление геоданных
---------------------

NextGIS QGIS предоставляет пользователю возможность добавлять:

* Векторные данные.
* Растровые данные.
* Использовать тайловые подложки из интернета.
* Добавлять растры по протоколу WMS и TMS.
* Работать по протоколу WFS.
* Добавлять слои из веб-гис NextGIS WEB.
* Предоставляет возможность пользователю добавлять собственные данные.

Добавление растровых и векторных слоёв из файлов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Геоданные бывают векторные и растровые. Векторные данные обычно хранятся как электронная 
таблица, где у каждой записи есть своя геометрия - то есть фигура, заданная координатами 
точек. Растровые данные обычно сохраняются как картинка, в которой указано, на какое 
место земного шара она ложится.

Существует множество форматов хранения геоданных и протоколов их передачи по сети. 
Они могут представлять собой файлы или находиться в базах данных. Преобразованием 
форматов занимаются утилиты :program:`GDAL` (растровые) и :program:`OGR` (векторные). 
Благодаря этим утилитам :program:`NextGIS QGIS` может читать и записывать разные 
форматы данных без сильных различий для пользователя. Разумеется, обычно используются 
только самые общеупотребительные форматы.

Понятие Слой будет часто встречаться в инструкции. Слой - это геоданные с определенным
составом и оформлением. Карта состоит из одного или нескольких слоев.

Вам потребуется знать: место, где лежат файлы на диске, их кодировку.

Если слой растровый, то скорее всего он будет в формате GeoTIFF (с расширением .tif)
:menuselection:`Слой --> Добавить слой --> Добавить векторный слой` или :menuselection:`Слой --> Добавить слой --> Добавить растровый слой` соответственно.

При открытии ESRI Shapefile в этом диалоге нужно выбирать файл с расширением .shp.

В середине 2010-х годов принято, что все данные сохраняются в кодировке UTF-8. При 
работе на ОС Windows при открытии и сохранении векторных данных нужно явно указывать 
кодировку UTF-8. По умолчанию она может быть System - это значит CP1251. Если вы 
открыли файл в неправильной кодировке, то русские буквы там будут нечитаемыми. 
В этом случае нужно в свойствах слоя выставить кодировку UTF-8. Но лучше сразу 
выставлять её при открытии файла, чтобы не забыть.

Также вам необходимо знать кодировку файлов. Если кодировка файлов - UTF-8, то 
при работе в ОС Windows в поле "Кодировка" рекомендуется выбирать UTF-8, потому 
что по умолчанию там будет выбрана системная кодировка, и тогда слой откроется в 
Win-1251. 

.. note::
   Если в таблице атрибутов вы увидите нечитаемые символы, переключите кодировку 
   между UTF-8 и Win-1251 в свойствах слоя.

Добавление картоподложки из интернета
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Осуществляется плагином QuickMapServices. 
Картографическая подложка часто выступает в качестве первого слоя, добавляемого для 
работы в проект. Подложка часто представлена в виде различных интернет-сервисов: 
TMS, WMS, WMTS, ESRI ArcGIS Service или просто в виде тайлов XYZ.
Но запомнить адреса интернет-сервисов сложно, а процесс их ввода каждый раз при смене 
рабочего места отнимает достаточно много времени.
Поэтому для оптимизации работы разработали QuickMapServices — расширение, которое 
позволяет быстро и удобно работать с базовыми картами (подложками), получаемыми из 
различных интернет-сервисов в проект QGIS. 
В QuickMapServices есть два хранилища для подложек: базовое и дополнительное. Подложки 
из базового набора устанавливаются и включаются вместе с модулем расширения.
Описание модуля находится в главе :ref:`ngq_qms`.

Работа с базами данных PostGIS
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Вам потребуется знать URL сервера PostGIS, название базы данных, имя пользователя 
и пароль.

Для добавления слоя PostGIS на карту нажмите :menuselection:`Слой --> Добавить слой --> Добавить слой PostGIS`.
Откроется окно :guilabel:`Добавить таблицы PostGIS`. 

.. figure:: _static/table_postgis.png
   :align: center

   Окно "Добавить таблицы PostGIS".

В списке Соединения выберите заранее сохранёное подключение или, если его нет, то нажмите :guilabel:`Создать` (соединение).
Откроется окно :guilabel:`Новое PostGIS-соединение`. Введите туда известные вам 
параметры. Нажмите кнопку :guilabel:`Проверить соединение`. Если выведется сообщение 
об ошибке, значит вы либо ввели неправильные параметры, либо неправильно настроена 
база данных, либо неправильно настроена сеть. Если выведется сообщение об успешном 
подключении, то всё в порядке. 

.. note::
   Для удобства в работе установите флажки напротив полей "Сохранить пользователя" и 
   "Сохранить пароль". 

.. figure:: _static/new_compound_postgis.png
   :align: center

   Окно "Новое PostGIS-соединение".

Далее в окне :guilabel:`Добавить таблицы PostGIS` выберите в списке новое подключение, 
нажмите кнопку :guilabel:`Подключиться`.
В списке таблиц появится список таблиц и хранимых представлений PostGIS, которые 
видно в базе данных. Выберите одну или несколько таблиц и нажмите :guilabel:`Добавить`.

.. figure:: _static/add_table_postgis.png
   :align: center

   Окно с таблицами PostGIS. 
 
Дальнейшая работа со слоями PostGIS осуществляется в :program:`NextGIS QGIS` точно 
так же, как с векторными слоями из файлов. 

Работа по протоколу WMS
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Вам потребуется знать URL сервиса WMS.

Для добавления слоя WMS на карту нажмите :menuselection:`Слой --> Добавить слой --> Добавить слой WMS/WMTS`.
Откроется окно :guilabel:`Добавить слой WMT(S)`. 

.. figure:: _static/add_layer_wms.png
   :align: center
  
   Окно "Добавить слой WMT(S)".

В списке Соединения` выберите заранее сохранёное подключение или, если его нет, нажмите :guilabel:`Создать` (соединение).
Откроется окно :guilabel:`Создание нового соединения WMS`. Введите туда известные 
вам параметры адреса и придумайте название.
Далее в окне :guilabel:`Добавить слой WMT(S)` выберите в списке новое подключение, 
нажмите кнопку :guilabel:`Подключиться`.
Выведется список слоёв, который видно в сервисе. Выберите один или несколько слоёв 
и нажмите :guilabel:`Добавить`. 

.. figure:: _static/add_layer_table_wms.png
   :align: center

   Окно таблицы "Добавить слой WMT(S)".  

Можно добавлять слои по отдельности. В этом случае в :program:`NextGIS QGIS` слои 
будут видны как отдельные. Можно выделить несколько слоев, тогда они будут отдаваться 
с сервера как один слой. Дальнейшая работа со слоями WMS осуществляется в :program:`NextGIS QGIS` 
так же, как с растровыми слоями из файлов. 

Работа по протоколу WFS
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для этого шага вам необходимо знать:

1. URL WFS-сервиса.
2. Логин.
3. Пароль.

Заходим в меню :menuselection:`Слой --> Добавить слой --> Добавить слой WFS`.

.. figure:: _static/MapWFS01.png

В открывшемся окне :guilabel:`Добавить слой WFS` нажимаем кнопку :guilabel:`Создать`.

.. figure:: _static/MapWFS02.png

В открывшемся окне :guilabel:`Создание нового WFS-соединения`вводим параметры:

1. :guilabel:`Название` - вводим любое название.
2. :guilabel:`Адрес` - URL WFS-сервиса.
3. :guilabel:`Пользователь` - при наличии.
4. :guilabel:`Адрес` - при наличии.

.. figure:: _static/MapWFS03.png

5. Далее выбираем созданное подключение и нажимаем "Подключиться".
6. Выбираем из списка необходимые слои (у нас он пока один).

Подключение к слоям NGW
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Из :program:`NextGIS QGIS` можно работать с NextGIS Web напрямую. Можно смотреть 
и редактировать данные - перемещать, удалять, добавлять новые объекты в слой. Это 
осуществляется плагином NGW Connect. Описание модуля находится в главе :ref:`NGW_Connect`.

Создание новых слоёв
-----------------------------

Есть 2 способа создания новых слоев:

1. :menuselection:`Слой --> Создать слой --> Создать Shape-файл`. Следует задать 
   тип геометрии и набор атрибутов, указать путь сохранения файла. Слой добавляется, 
   а затем добавляете туда геометрию.
 
2. :menuselection:`Слой --> Создать слой --> Создать временный слой`. Задать тип 
   геометрии, слой добавляется, затем добавляете туда геометрию и атрибуты. Затем 
   сохраняете его как Shape-файл или в другом необходимом вам формате.

.. note::
   В Shape-файл и во временный слой можно добавлять и удалять атрибуты и после создания.


Ограничения формата ESRI Shapefile
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Имя атрибута должно быть написано латинскими буквами, но не более 12 символов. 
Текстовое поле не может хранить данные длинее 255 символов. 

.. _ngq_projections:

Проекции
-----------------------------

Краткая инструкция по работе с проекциями
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

В :program:`NextGIS QGIS` есть возможность работы с проекциями. У каждого слоя данных 
есть своя система координат (в которой хранятся данные), как правило она записана 
в самом файле. Почти всегда в :program:`NextGIS QGIS` используется функция "преобразования 
координат на лету": слои хранятся в разных системах координат, а на экран они выводятся в одной. 

Систем координат очень много, однако для работы одновременно используется всего 2-4 штуки, 
их можно запомнить. 

* WGS 84 (EPSG:4326) - в ней обычно хранятся векторные данные. Единица измерения
  - градусы. Новые векторные файлы сохраняйте в ней. Если вывести данные из неё 
  без перепроецирования, то картинка будет сплющенной.
* Pseudo Mercator (EPSG:3857) - используется для отображения. Включайте "перепроецирование
  на лету" в 3857, и карта будет отображаться более правильно.
* WGS 84 / UTM Zone X (EPSG:32610..32709) - используется для измерения расстояний. 
  Данные хранятся в метрах. Некоторые инструменты требуют её для корректной работы. 
  Так же в ней могут храниться космоснимки. Земной шар разделён на 30 зон, для 
  каждой определена своя проекция - свой код EPSG. 
* Pulkovo 1942 / Gauss-Kruger zone X (EPSG:28401..28432 и соседние) - устроена 
  так же как UTM, в ней хранятся привязанные листы советских топокарт (изданных 
  в последние годы). Так же разделена на зоны, но с другими номерами. 

.. todo::
   возможно сверстать в таблицу

Основные операции с проекциями, которые нужно знать для работы:
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Как узнать систему координат слоя
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

:menuselection:`Слой --> Свойства --> Вкладка Общие --> Система координат`. 
Это значение можно менять. Систему координат сохранёную в слое можно узнать  
:menuselection:`Слой --> Свойства --> Вкладка Метаданные --> строка "Система 
координат слоя"`.

Открытие окна преобразования координат
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

В правом-нижнем углу карты нажмите вторую справа кнопку. Если на ней написано OTF, 
значит преобразование на лету включёно.

Если картинка на карте сплющена по вертикали
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Если вы добавили геоданные на карту, и картинка сплющенная, то включите "Преобразование 
коодинат на лету" в EPSG:3857. Это значит, что ваши геоданные были в градусах.


Если данные из разных слоёв не попадают друг на друга, хотя они в одном месте
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Включите "Преобразование коодинат на лету".

Пересохранение слоёв в другую систему координат
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Для некоторых операций в инструкции потребуется пересохранить слои в другую систему 
координат. В этом случае выберите :menuselection:`Слой --> Сохранить как`, и выберите 
систему координат в диалоге сохранения. 


Проекции - подробная теория
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

В :program:`NextGIS QGIS` реализована возможность работы с проекциями. Проекция 
может быть установлена как глобально, т.е. её параметры будут применены к любому 
векторному слою, не содержащему информации о проекции, так и отдельно для проекта. 
Кроме того, существует возможность создания собственных проекций, а также реализована 
поддержка перепроецирования "на лету" для векторных и растровых слоёв. Все эти функции 
позволяют корректно отображать одновременно несколько слоёв, находящихся в различных 
проекциях.

Все проекции в :program:`NextGIS QGIS` основаны на базе идентификаторов European Petroleum Group (ESPG) и Institut Geographique National of France (IGNF) и в значительной степени абстрагированы 
от таблицы spatial_references в PostGIS версии 1.x. EPSG-коды хранятся в базе данных 
и могут быть использованы для определения проекции.

Для корректной работы перепроецирования "на лету" слой должен содержать информацию о 
проекции, в которой хранятся данные, либо она должна быть определена самостоятельно 
на уровне слоя или проекта. Для слоёв PostGIS :program:`NextGIS QGIS` использует 
идентификатор проекции, определяемый в момент создания слоя. Для данных, хранящихся 
в форматах, поддерживаемых OGR, информация о проекции должна быть представлена в 
соответствующем файле, структура которого определяется форматом. В случае shape-файлов - 
это файл, содержащий описание проекции в формате Well Known Text (WKT) и имеющий 
то же имя, что и shape-файл, но с расширением .prj. Например, для файла alaska.shp 
файлом описания проекции будет alaska.prj.

Всякий раз, когда происходит выбор новой проекции, используемые единицы слоя автоматически
изменяются, что можно увидеть, перейдя во вкладку Общие диалогового окна - Свойства проекта,
открываемого по нажатию кнопки Редактировать (Gnome, OS X) или Настройки (KDE, Windows)

Установка проекции
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

:program:`NextGIS QGIS` создаёт новые проекты с использованием системы координат 
по умолчанию. Изначально используется система координат EPSG:4326 - WGS 84. Это 
значение можно изменить, нажав кнопку "Выбрать" в первой группе настроек во вкладке 
"Система координат" (см. рисунок :numref:`ngmobile_coordinate_systemc_configuration_pic`). 
Указанное значение будет использоваться по всех последующих сеансах работы.

Окно Параментры сети представлено на рисунке см. :numref:`ngmobile_coordinate_systemc_configuration_pic`:

.. figure:: _static/coordinate_systemc_configuration.png
   :name: ngmobile_coordinate_systemc_configuration_pic
   :align: center
   :height: 10cm
   
   Настройки системы координат. 

При загрузке в проект слоёв, не содержащих информации о проекции, необходимо иметь 
возможность контролировать и определять проекции таких слоёв. Проекции могут быть 
установлены глобально или на уровне проекта. Для выполнения этой операции перейдите 
во вкладку "Система координат окна", открываемого через Редактирование - Параметры 
(Gnome, OS X) или Установки - Параметры (KDE, Windows).

На рисунке :numref:`ngmobile_coordinate_systemc_configuration_pic` показаны 
возможные варианты:

1. Запрашивать систему координат.
2. Использовать систему координат проекта.
3. Использовать указанную систему координат.

Если необходимо задать проекцию для слоя, в котором информация о ней отсутствует, 
то это можно сделать во вкладке Общие окна свойств растрового (см. Общие) или 
векторного (см. Общие) слоя. Если слой уже содержит информацию о проекции, то вкладка 
будет выглядеть как показано на рисунке Vector Layer Properties Dialog (рис.11.6).
 
Контекстное меню слоя содержит два элемента для работы с системой координат. 
Пункт меню Изменить систему координат вызывает диалог Выбор системы координат 
(см. рисунок :numref:`ngmobile_coordinate_systemc_configuration_pic`). 
А пункт Выбрать систему координат слоя для проекта устанавливает систему координат 
проекта равной системе координат слоя.

QGIS поддерживает перепроецирование растровых и векторных слоёв "на лету", но по 
умолчанию эта возможность отключена. Для её активации необходимо установить флажок 
"Включить преобразование координат "на лету" на вкладке "Система координат" диалогового 
окна "Свойства проекта".
 
Существует три способа доступа к указанной вкладке:

1. Выберите пункт "Свойства проекта" в меню Редактирование (Gnome, OS X) или Установки
   (KDE, Windows).

2. Нажмите кнопку "Преобразование координат", расположенную в правом нижнем углу 
   строки состояния.

3. Включить преобразование координат "на лету" по умолчанию на вкладке "Система координат"
   диалога Параметры, активировав флажок "Включить преобразование координат "на лету".

Если имеется загруженный в проект слой и вы желаете включить перепроецирование "на лету", 
то откройте вкладку Система координат диалогового окна Свойства проекта, выберите 
проекцию и отметьте пункт Включить преобразование координат "на лету" (см. рисунок
:numref:`ngmobile_reprojection_on_the_fly_pic`). Значок Преобразование координат 
станет активным и все последующие загружаемые слои будут автоматически перепроецироваться 
в выбранную проекцию.

.. figure:: _static/reprojection_on_the_fly.png
   :name: ngmobile_reprojection_on_the_fly_pic
   :align: center
   :height: 10cm

   Перепроецирование "на лету". 

Вкладка Система координат диалогового окна Свойства проекта содержит пять важных 
компонентов, показанных на рисунке :numref:`ngmobile_reprojection_on_the_fly_pic` 
и описанных ниже.

1. Включить преобразование координат "на лету". Данный пункт используется для включения 
или отключения преобразования координат "на лету". Если он отключен, то каждый слой 
отрисовывается в соответствии с проекцией, указанной в источнике данных, и элементы,
описанные ниже, будут неактивными. Если данный пункт отключен, то координаты слоя 
перепроецируются в проекцию карты.

2. Система координат - список проекций, поддерживаемых QGIS, включая географические,
прямоугольные и пользовательские. Для выбора проекции выделите её имя в списке, 
предварительно развернув нужный узел. Текущая проекция выделена цветом.

3. Proj4 - текстовое представление проекции в формате PROJ.4. Данный текст доступен 
только для чтения и используется в качестве справочной информации.

4. Поиск - если вам известен EPSG-код, идентификатор или имя проекции, то можно 
воспользоваться поиском. Введите идентификатор и нажмите кнопку Найти. Отметьте
Скрыть устаревшие системы координат, чтобы показывать только используемые в настоящее 
время проекции.

5. Недавно использованные системы координат - если имеются определённые наиболее 
часто используемые в проектах проекции, то они будут доступны в таблице, расположенной 
в верхней части диалога Выбор системы координат. Нажмите на одну из строк, чтобы 
выбрать эту систему координат.

Если открыть Свойства проекта из меню Редактирование (Gnome, OS X) или Установки 
(KDE, Windows), то для доступа к настройкам проекций нужно перейти во вкладку Система 
координат. Если же воспользоваться кнопкой Преобразование координат, то вкладка 
Система координат откроется автоматически.

Если вы не нашли нужной проекции, то можно определить собственную. Для этого выберите 
пункт Ввод системы координат меню Редактирование (Gnome, OS X) или Установки (KDE, Windows).
Пользовательские проекции хранятся в пользовательской базе данных. Помимо собственных 
проекций эта база содержит пространственные закладки и прочую информацию.

Для создания собственной проекции необходимо хорошо разбираться в синтаксисе библиотеки 
поддержки картографических проекций PROJ.4. Рекомендуется ознакомиться с документом 
"Cartographic Projection Procedures for the UNIX Environment - A User’s Manual"
(Gerald I. Evenden, U.S. Geological Survey Open-File Report 90-284, 1990), доступным 
по адресу ftp://ftp.remotesensing.org/proj/OF90-284.pdf.
Данное руководство описывает использование proj.4 и связанных утилит командной строки. 
Картографичские параметры, используемые в proj.4, описаны в руководстве и совпадают 
с используемыми в NextGIS QGIS.

В диалоговом окне Определение пользовательской системы координат требуется всего 
два параметра для определения собственной проекции:

1. Имя проекции.

2. Картографические параметры в формате PROJ.4.

Для создания новой системы координат нажмите кнопку Новая, укажите имя и введите 
необходимые параметры. После чего созданную проекцию можно сохранить, нажав кнопку
Сохранить.
Значение поля Параметры создаваемой проекции должно начинаться со строки +proj=.
Создаваемую проекцию можно проверить. Для этого вставьте параметры создаваемой 
проекции в поле Параметры раздела Проверка. Затем введите значения широты и долготы 
WGS-84 в поля Север и Восток соответственно. Нажмите кнопку Рассчитать и сравните 
результат с известными значениями вашей проекции :numref:`ngmobile_user_coordinate_system_pic`).

.. figure:: _static/user_coordinate_system.png
   :name: ngmobile_user_coordinate_system_pic
   :align: center
   :height: 10cm

   Пользовательская система координат.

Настройка стилей
-----------------

Картостиль - это описание цветов, текстур, значков, толщины линий, подписей и прочих 
особенностей отображения слоёв на экране. Эти настройки хранятся отдельно от географических 
данных, их можно сохранять в отдельные файлы и копировать между слоями. Настройка 
осуществляется через :menuselection:`Слой --> Свойства слоя --> Оформление` 
или :menuselection:`Слой --> Свойства слоя --> Подписи`. Для каждого слоя задаётся 
отдельное оформление.

.. _ngq_vector_styles:

Настройка оформления векторных слоёв
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

В описании об оформления векторного слоя используется 3 типа символов: 

1. Тип символов.
2. Тип символьного слоя.
3. Тип классификации. 


* **Тип символа** - символы различаются по типу: для точечных, линейных и полигональных слоёв символы различаются. Это не изменяется. Сами символы могут состоять из одного или нескольких символьных слоёв. 

.. figure:: _static/styles_type1.png
   :height: 5cm
   :align: center

   Примеры символов для точечных, линейных и полигональных слоёв.

.. todo::
   Отрендрить картинку на компьютере.

* **Тип символьного слоя** - задаёт способ заливки: цветом, штриховкой, SVG, маркерами, 
  или способ рисования линии: пунктирная линия, линия из маркеров.

.. figure:: _static/styles_type2.png
   :name: styles_tipy_simvolnogo_sloya
   :height: 5cm
   :align: center

   Варианты типов символьного слоя доступные для точечных, линейных и полигональных слоёв.


* **Тип классификации** - задаёт способ, как рисовать разные символы для разных объектов 
  в одном слое: все одинаково или по-разному. 

.. figure:: _static/styles_type3.png
   :height: 5cm
   :align: center 

   Варианты типов классификации.
    

Для настройки стиля выделите нужный стиль в списке слоёв, и откройте окно настройки стиля: :menuselection:`Слой --> Свойства слоя --> вкладка Оформление`.


.. figure:: _static/styles_stylewindow1.png
   :name: styles_stylewindow_default
   :height: 10cm
   :align: center 

   Окно настройки стиля в режиме классификации Обычный знак, которое открывается по умолчанию.

   1. Список типов классификации.
   2. Изображение знака.
   3. Список символьных слоёв в текущем символе.
   4. Кнопки добавления-удаления символьных слоёв.

Если в списке символьных слоёв выбрать один слой, то появится окно настроек символа.
Его вид будет разным в зависимости от выбранного типа символьного слоя.


.. figure:: _static/styles_stylewindow2.png
   :name: styles_stylewindow_stylelayers
   :height: 10cm
   :align: center

   Окно настроек символа.

   1 - список типов символьных слоёв.


См. так же http://www.qgistutorials.com/ru/docs/basic_vector_styling.html.

Доступные типы символьных слоёв
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* Для точечных слоёв:

  * **Символьный маркер**: отрисовка с использованием определенного символа заданного 
    шрифта.

  * **Простой маркер**: отрисовка с использованием одного из предустановленных маркеров.

  * **SVG маркер**: отрисовка с использованием SVG изображения.

  * **Эллипс**: отрисовка с использованием геометрических примитивов (эллипс, прямоугольник, 
    треугольник, перекрестие).

  * **Векторное поле**: отрисовка векторным полем с использованием значений атрибутивной 
    таблицы.

* Для линейных слоёв:

  * **Обрамление линии**: добавляет элементы оформления, например, стрелку для указания 
    направления линии.

  * **Маркерная линия**: отрисовка линии повторением маркерного символа.

  * **Простая линия**: обычная отрисовка линии (с указанными шириной, цветом и стилем).

* Для полигональных слоёв:

  * **Отрисовка центроидов**: отрисовка центроида полигона при помощи одного из 
    предустановленных маркеров.

  * **Заливка SVG-шаблоном**: Заливка полигона SVG изображением.

  * **Простая заливка**: обычная отрисовка полигона (с определенным цветом заливки, 
    шаблоном заливки и контуром).

  * **Заливка штриховкой**: заливка полигона линейной штриховкой.

  * **Заливка маркерами**: заливка полигона заданным маркером.

  * **Обводка: обрамление линии**: добавляет элементы оформления (например, кружки) 
    к контуру полигона.

  * **Обводка: маркерная линия**: контур отрисовывается путем повторения маркерного 
    символа.

  * **Обводка: простая линия**: обычная отрисовка линии (с указанными шириной, цветом 
    и стилем).

Доступные типы классификации слоев
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Возможно выбрать один из пяти типов: 

1. Обычный знак.
2. Уникальные значения.
3. Градуированный знак.
4. Правила.
5. Точки со смещением.

Обычный знак
"""""""""""""""""""""""""""""""""""""""""""

Используется для отрисовки всех элементов слоя с использованием одного, определенного 
пользователем, символа. Свойства, которые можно задать во вкладке Стиль, частично 
зависят от типа слоя.


Уникальные значения
"""""""""""""""""""""""""""""""""""""""""""

Объекты с разным значением какого-нибудь атрибута рисуются разными цветами.

Отрисовка уникальными значениями используется для отрисовки всех элементов слоя 
единым, определенным пользователем, символом, цвет которого отражает значение выбранного 
атрибута элемента. Вкладка Стиль позволяет выбрать:

1. Поле (в списке полей).
2. Знак (в диалоге Выбор условного знака).
3. Градиент (в списке цветовых шкал).

Кнопка Дополнительно в нижнем левом углу окна позволяет указать поля с 
информацией о вращении и масштабе. Для удобства список в нижней части вкладки 
показывает значения всех заданных на данный момент атрибутов, включая символы, к 
которым в будущем будет применена отрисовка.
Рисунок :numref:`ngmobile_dialogue_rendering_unique_values_pic` иллюстрирует 
диалог отрисовки уникальными значениями из демонстрационного набора данных QGIS:

.. figure:: _static/dialogue_rendering_unique_values.png
   :name: ngmobile_dialogue_rendering_unique_values_pic
   :align: center
   :height: 10cm

   Диалог отрисовки уникальными значениями.

Можно создавать свои градиенты, выбрав Новый градиент из выпадающего списка Градиент.
В появившемся окне можно выбрать тип градиента: "Градиент", "Случайный" или
"ColorBrewer", для каждого из которых можно задать желаемое количество цветов. 

Градуированый знак
"""""""""""""""""""""""""""""""""""""""""""

Цвет будет плавно изменяться в зависимости от числового значения какого-либо атрибута.
 
.. figure:: _static/graduated_mark.png
   :name: graduated_mark_pic
   :align: center
   :height: 10cm

   Фрагмент диалога свойств слоя - Градуированный знак. 

Правила
"""""""""""""""""""""""""""""""""""""""""""

Используется для отрисовки всех элементов слоя с помощью символов, базирующихся на 
определенных правилах. Задаётся несколько выражений/правил. Каждое выражение выдаёт 
несколько записей и оформляется по-своему. Может быть разным не только цвет, но и 
другие параметры.

Точки со смещением
"""""""""""""""""""""""""""""""""""""""""""

Только для точечных слоёв. В данном стиле при задании значения Порога расстояния 
между точками (вкладка Свойства слоя - Стиль) точки группируются с учетом значения 
Порога расстояния между точками. Далее при отображении на карте внутри группы точек 
выбирается точка, вокруг которой выстраиваются остальные точки по кругу с радиусом, 
соответствующим значению Порога расстояния между точками.

.. figure:: _static/styles_point_offset.png
   :name: styles_point_offset_pic
   :align: center
   :height: 10cm

   Фрагмент карты после применения стиля "Точки со смещением". 

Инвертированные полигоны
"""""""""""""""""""""""""""""""""""""""""""

Только для полигональных слоёв. При использовании данного стиля (вкладка Свойства слоя - Стиль) 
происходит заливка цветом областей за пределами полигона (снаружи полигона), сам 
полигон остается прозрачным. 

.. figure:: _static/styles_inverted_polygons.png
   :name: styles_inverted_polygons_pic
   :align: center

   Фрагмент карты До и После применения стиля "Инвертированные полигоны".

Создание теплокарт
"""""""""""""""""""""""""""""""""""""""""""

Вся карта заливается фоновым цветом (можно сделать прозрачным). Вокруг каждой точки 
рисуется размытый круг, если рядом много точек, то круг более насыщенный.

В настройках градиента можно выбрать прозрачный цвет. 
Качество отрисовки обозначает размер пикселей.


.. figure:: _static/styles_heatmap_00.png

   Точки.

.. figure:: _static/styles_heatmap_01.png

   Теплокарта с настройками по умолчанию.

.. figure:: _static/styles_heatmap_02_owngradient.png

   Свой градиент.

.. figure:: _static/styles_heatmap_03_gradienttransparent.png

   Градиент, начинающийся с прозрачного цвета.

.. figure:: _static/styles_heatmap_04_quick.png

   Самый быстрый.

.. figure:: _static/styles_heatmap_05_quality.png

   Самый качественный.

.. figure:: _static/styles_heatmap_06_discret-quality.png

   Дискретный градиент - качественный.

.. figure:: _static/styles_heatmap_07_discret-quick.png

   Дискретный градиент - быстрый.

.. figure:: _static/styles_heatmap_08_bigradius.png

   Средний радиус.

.. figure:: _static/styles_heatmap_09_smallradius.png

   Занизить радиус.

.. figure:: _static/styles_heatmap_10_radiusverybig.png

   Завысить радиус.

.. figure:: _static/styles_heatmap_11_maxvalueauto.png

   Максимальное значение - авто.

.. figure:: _static/styles_heatmap_11_maxvaluelow.png

   Максимальное значение - занизить.

.. figure :: _static/styles_heatmap_13_complexgradient.png

   Сложный градиент с промежуточными цветами.

.. слишком много картинок подряд - не компилируется 
.. 
.. .. figure :: _static/styles_heatmap_14_weightauto.png
..
..   Взвешивание - автоматическое. Интенсивность обозначает концентрацию точек.
..
.. .. figure :: _static/styles_heatmap_15_weightattr.png
..
..   Взвешивение - по атрибуту (количество мест). Интенсивность обозначает 
..   суммарное количество мест в заведениях.


Эффекты отрисовки
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для всех режимов отображения можно задать эффекты отрисовки слоя - как например 
тень, свечение, внешнюю или внутреннюю линию.

.. figure:: _static/styles_effects.png

   Фрагмент карты с различными отрисовками.

Подписи
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Можно выводить подписи у объектов векторных слоёв. Текст подписи можно брать из атрибута, 
можно составлять выражением в зависимости от значений атрибутов. Остальные свойства 
подписи - цвет, размер, положение, поворот - тоже можно брать из атрибутов.


Для настройки стиля выделите нужный стиль в списке слоёв и откройте окно настройки 
стиля: :menuselection:`Слой --> Свойства слоя --> вкладка Подписи`.

В открывшемся окне в списке режима подписей выберите Показывать подписи для этого 
слоя. Затем в списке атрибутов выберите поле, из которого будет браться надпись.

Оформление растровых слоёв
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для растровых слоёв существует 4 разных способа визуализации: два - для одноканальных 
растров, два - для многоканальных. 

.. note::
   Настройки оформления различаются для разных форматов. Большее количество 
   настроек оформления существует для формата GeoTIFF, а для слоёв WMS и TMS 
   настроек оформления меньше.

Многоканальное цветное
"""""""""""""""""""""""""""""""""""""""""""

Используйте этот способ оформления, если у вас многоканальный растр, например - 
цветной космоснимок или скан карты в RGB. 

Индексированое
"""""""""""""""""""""""""""""""""""""""""""

Картинка рисуется по данным из одного выбранного канала растра. Каждое значение 
растра рисуется отдельно заданным цветом. 

Одноканальное серое
"""""""""""""""""""""""""""""""""""""""""""

Картинка рисуется по данным из одного выбранного канала растра, чёрно-белой.

Одноканальное псевдоцветное
"""""""""""""""""""""""""""""""""""""""""""

Картинка рисуется по данным из одного выбранного канала растра, по цветному градиенту.

При всех способах визуализации можно задавать прозрачность, яркость, контрастность 
и тонирование в цвет. 

.. _ngq_save_style:

Сохранение стиля
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Стиль можно сохранить в файл. В нём сохранится настройки оформления и настройки подписей. 


.. figure:: _static/styles_save.png
   :name: styles_save
   :align: center

   Диалог сохранения стиля.

В окне свойства стиля нажмите на кнопку :guilabel:`Стиль` (см. :numref:`styles_save`). 

По нажатию на кнопку :guilabel:`Сохранить настройки по умолчанию` стиль сохранится в 
формате qml в каталоге, где лежит стиль, и с тем же названием. Теперь, если вы будете 
добавлять этот слой как новый, то QGIS подхватит и его стиль тоже.

Пункт :guilabel:`Сохранить стиль` - позволяет сохранить его в другой файл, а так же в формат sld.


.. _ngq_composer:

Компоновщик карты
------------------

Компоновщик карты используется для оформления и подготовки макета карты и атласа, 
которые можно распечатать, сохранить как PDF-файл, изображение или SVG-файл. Это 
способ для распространения географической информации созданной в :program:`NextGIS QGIS`, 
которую можно использовать в отчётах или публиковать.
Если же вам нужно показывать интерактивную карту через веб, то воспользуйтесь QTiles 
или NextGIS Web.

.. todo::
   Поставить гиперссылку.

Компоновщик карты предоставляет возможности вёрстки (размещения карт легенд и других 
объектов на листе) и печати. Он позволяет добавлять такие элементы:

1. Карты.
2. Подписи.
3. Картинки.
4. Список условных обозначений.
5. Масштабные линейки.
6. Сетки на карте.
7. Фигуры.
8. Стрелки.
9. Таблицы данных.
10.HTML-фреймы. 

Вы можете масштабировать, группировать, перемещать и поворачивать каждый элемент. 
Макет может состоять из нескольких страниц. Макет можно сохранять в проекте. Так же 
макет может быть использован для генерации атласа - сборника из нескольких карт. 

Открытие компоновщика карты
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Перед началом работы в компоновщике карты нужно добавить в :program:`NextGIS QGIS` 
нужные слои и настроить их оформление соответственно вашим потребностям. Когда в 
основном окне карта отображается так, как вам нужно, нажмите :menuselection:`Проекты --> Создать макет`.
В диалоге вам предлагается ввести имя для нового макета карты. Его можно оставить пустым. 

.. todo::
   Найти точное название кнопки

Обзор окна Компоновщика карты
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. todo::
   Заменить подписи в {} на image с изображением кнопок с tooltip

При открытии нового окна Компоновщика карты в нём будет белая область компоновки карты,
изображающая лист бумаги. В левой части окна находится панель кнопок, которые добавляют 
объекты в область компоновки: текущую карту из :program:`NextGIS QGIS`, надписи, 
картинки, легенду, масштабные линейки, стрелки, таблицы атрибутов и HTML-фреймы. 
Так же в этой панели находятся кнопки перемещения по области компоновки. 
Это начальный вид окна Компоновщика карты без добавления каких-либо элементов 
и выполненных команд. 

Справа посредине находится панель c 3 вкладками: :guilabel:`Макет`, :guilabel:`Свойства Элемента` и :guilabel:`Атлас`.

На вкладке Макет задаются параметры бумаги: формат и соотношение сторон. 
Регулятором Количество страниц можно добавить страницы в макет: их можно сверстать по-разному. 
Регулятором Разрешение задаётся разрешение изображения в dpi. 

.. todo::
   картинка: карта с 2 страницами (или не нужно? Спросить)

Содержимое вкладки :guilabel:`Свойства Элемента` бывает разное для каждого выделенного 
элемента в области компоновки карты. Выделите в ней карту или масштабную линейку 
инструментом (стрелка) - содержимое вкладки будет другим.

На вкладке :guilabel:`Атлас` можно указать слой, по содержимому которого будет разрезаться 
карта на отдельные страницы атласа. 

Вкладка История команд отображает историю всех изменений, сделаных в макете. Здесь
можно как отменить сделанные изменения, так и повторить ранее отмененные действия.

Макет сохраняется внутри файла проекта. Макетов может быть несколько.

Настройки карты
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. todo::
   Заменить подписи в {} на image с изображением кнопок с tooltip

Для печати карты - добавьте элемент карты в окно компоновщика:

1. Нажмите кнопку добавить карту.
2. Начертите прямоугольник в области карты.
3. Выделите карту в области компоновки: щёлкните на неё инструментом (стрелка) и 
   проверьте, рисуются ли квадратики по бокам элемента. 
4. Откройте вкладку Свойства элемента. 
5. Необходимо настроить :term:`охват` карты с масштабом и набор слоёв. 

Выберите инструмент (переместить содержимое элемента). 
Для перемещения по карте - нажмите и ведите по карте мышкой - карта будет сдвигаться. 
Для изменения масштаба карты - вращайте колесо мыши. Если вращать с нажатой клавишей Ctrl - 
масштаб будет меняться с меньшим шагом. 
На вкладке Свойства элемента можно ввести точное значение масштаба с клавиатуры в поле Масштаб. 
По нажатию кнопки Текущий охват - охват выставится такой же, как у основного окна :program:`NextGIS QGIS`. 
По нажатию кнопки Установить охват для основной карты - охват основной карты выставится 
такой же, как у карты из макета. 
Охват сохраняется в макете, и изменения в основном окне :program:`NextGIS QGIS` 
на него не влияют: вы можете в основном окне двигать карту, а в макете она останется такой же. 

Комбинация и порядок слоёв, а так же стили по умолчанию не сохраняются: если вы 
их переставите в основном окне, то в макете они поменяются. Но их изменение можно 
заблокировать кнопками (заблокировать слои для этой карты) и (Lock layer styles for map item).


.. todo::
   Дописать про многостраничный pdf и пачку jpg.

Генерация атласа
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Эта функция создаёт набор картинок с одинаковым макетом, но с картами разных мест. 
Она использует слой охвата, который содержит геометрии и поля. Для каждой геометрии 
в слое охвата будет создана страница, и охват карты на ней будет будет такой, что 
охватит геометрию слоя. Поля могут быть использованы для подписей. 

Выберите в макете карту. В её свойствах включите галку "Использовать для атласа".
Во вкладке :guilabel:`Атлас` выберите слой нарезки.
В окне компоновщика воспользуйтесь командами :menuselection:`Атлас --> Экспорт атласа`.


.. todo::
   можно сделать атлас районов области, можете нагенерить регулярную сетку с номерами. 

.. todo::
   Тут вообще не понял, как выговорить по-русски

.. todo::
   Написать про кнопки, потому что запускается из другого меню.


