.. sectionauthor:: Denis Rykov <denis.rykov@nextgis.com>

.. _add-new-layer-to-defaults:

Добавление нового слоя в список стандартных слоев для объекта строительства
===========================================================================

Каждый объект строительства, при его создании, наполняется определенным набором слоев. Данный набор содержит слои с:

* проектными данными
* актуальными данными по строительству
* данными, пришедшими с мобильных устройств
* дополнительными данными, вводимыми пользователями

Слои актуальных данных напрямую связаны со слоями данных, пришедших с мобильных устройств и участвуют во внутренней репликации данных.
Поэтому изменение списка этих слоев без изменения логики работы мобильного приложения не представляется возможным.

Набор слоев с дополнительными данными можно дополнять, но в данный момент, пользователи системы не имеет возможность напрямую редактировать эти данные.

Единственный набор слоев, который можно дополнять с пользой для конечных пользователей - проектные данные.

.. note:: Важно!
    Метод позволяет добавить новый проектный слой только для вновь создаваемых объектов строительства.
    Новый слой не появится в уже существующих объекты строительства,
    так как это требует создание новых ресурсов и их регистрацию в уже существующих сервисах редактирования данных WFS.
    В данный момент эти действия можно выполнить только подготовив соответствующую миграцию схемы данных (написание программного кода)

.. note:: Важно!
    Добавление нового слоя на рабочей системе без предварительной проверки на тестовом стенде может привести к полной неработоспособности системы.

Добавление нового слоя проектных данных происходит в несколько этапов.


Определение структуры слоя и подготовка файла с определением структуры
----------------------------------------------------------------------

Для возможности автоматической генерации новых ресурсов типа 'Векторный слой' необходима структура полей и другая метаинформация.
Для этого в директории

.. code:: bash

   /!install_path!/nextgisweb_compulink/nextgisweb_compulink/compulink_admin/layers_templates

располагаются файлы с определением структуры каждого проектного слоя, создаваемого автоматически.

Для добавления нового слоя, необходимо создать новый файл с расширением json (например 'new_layer.json') или скопировать любой уже существующий из данной директории как шаблон.
После этого необходимо отредактировать его содержимое в соответствии с планируемой структурой нового слоя.

Файл содержит 3 обязательные секции: 'resource', 'feature_layer', 'vector_layer'.

Секция 'resource' содержит описание основных настроек ресурса и требует заполнения полей 'display_name' и 'identify_name'.
Секция 'feature_layer' содержит только одно поле  'fields', которое является массивом структур с описаний каждого поля.
Каждое поле должно иметь следующие поля 'keyname', 'datatype', 'display_name', 'label_field' и 'grid_visibility'.
Секция 'vector_layer' содержит метаинформацию о геометрии будущего слоя - обязательные поля 'geometry_type' и 'srs'.'id'.


Создание файла со стилем оформления для нового слоя
---------------------------------------------------

Для возможности отображать новый слой на веб-карте необходимо предоставить системе файл с оформлением нового слоя в формате Mapserver.
Более подробно о создании\редактировании файлов стилей для стандартных слоев можно прочитать в разделе :ref:`update-styles`.
Название файла со стилем для нового слоя должен иметь тоже название что и файл структуры, созданный на предыдущем шаге, но с расширением .xml (например 'new_layer.xml').


Регистрация нового слоя в наборе создаваемых слоев
--------------------------------------------------

Слои, создаваемые системой в момент создания нового объекта строительства должны быть зарегистрированны в реестре соответствующих слоев.
Для добавления нового слоя в реестр проектных слоев необходимо отредактировать файл:

.. code:: bash

   /!install_path!/nextgisweb_compulink/nextgisweb_compulink/compulink_admin/layers_struct.py

В данном файле, в массиве FOCL_LAYER_STRUCT перечислены все слои относящиеся к проектным данным.
В этот массив необходимо добавить название нового слоя без расширения (например 'new_layer').


Регистрация нового слоя в наборе отображаемых слоев
---------------------------------------------------

Слои, отображаемые в группе проектных данных в веб-карте должны быть зарегистрированны в реестре соответствующих слоев.
Для добавления нового слоя в реестр отображаемых проектных слоев необходимо отредактировать файл:

.. code:: bash

   /!install_path!/nextgisweb_compulink/nextgisweb_compulink/compulink_admin/layers_struct_group.py

В данном файле, в массиве FOCL_LAYER_STRUCT перечислены все слои относящиеся к отображаемым проектным данным.
В этот массив необходимо добавить название нового слоя без расширения (например 'new_layer').


Перезапуск сервера приложений
-----------------------------
Так как добавление нового слоя приводит к изменению структуры создаваемых\отображаемых слоев, то это влечет необходимость перезапуска сервера приложений.
Для этого необходимо выполнить комманду:

.. code:: bash

    service uwsgi restart


Если все пункты выполнены корректно, вновь создаваемые объекты строительства будут иметь новый проектный слой, который будет отображаться в списке слоев на веб-карте.



