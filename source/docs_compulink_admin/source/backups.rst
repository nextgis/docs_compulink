.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>
.. sectionauthor:: Dmitry Baryshnikov <dmitry.baryshnikov@nextgis.com>


Миграция и резервное копирование
================================

Миграция – это процедура по переносу данных и настроенной NextGIS Web между 
серверами. В ходе процедуры миграции создается резервная копия, в которую 
записывается:

* Всё содержимое базы данных NextGIS Web: информация о слоях, стили, аккаунты 
  пользователей, то есть всё, что настраивается в интерфейсе администратора.
* Векторные данные, которые были загружены через интерфейс администратора.
* Растровые данные, которые были загружены через интерфейс администратора. 

Файл config.ini в резервную копию не включаются, его надо переносить отдельно.

Для запуска процедуры миграции необходимо выполнять следующие команды:

.. code:: bash

	env/bin/nextgisweb --config config.ini backup file.ngwbackup
	env/bin/nextgisweb --config config.ini restore file.ngwbackup

Резервная копия – это ZIP-архив. Для отключения архивации резервной копии 
необходимо указать ключ —no-zip. При это будет создан новый каталог с указанным 
именем.

.. code:: bash

	env/bin/nextgisweb  --config "config.ini" backup "backup/ngwbackup" --no-zip

В ОС FreeBSD есть ошибка: поддержка sqlite не переносится virtualenv. Нужно 
вручную скопировать файл:

.. code:: bash

	cp /usr/local/lib/python2.7/site-packages/_sqlite3.so \
	env/lib/python2.7/site-packages/


Миграция выполняется в следующем порядке:

1. На старом сервере запускается процедура резервного копирования.

.. code:: bash

	env/bin/nextgisweb  --config "config.ini" backup "backup/ngwbackup" --no-zip

2. Если необходимо перенести базу PostGIS с геоданными, то со старого сервера 
   делается ее резервная копия программой pgAdminIII в формате tar.
3. На новом сервере устанавливаем NextGIS Web согласно инструкции (см. разд. 2).
4. На новом сервере создается база данных для NextGIS Web, и настраиваются  
   права доступа программой pgAdminIII.
5. На новом сервере в файле config.ini необходимо указать подключение к базе 
   NextGIS Web.

 
.. code::

	# Имя сервера БД 
	database.host = localhost
	# Имя БД на сервере 
	database.name = zapoved_ngw
	# Имя пользователя БД 
	database.user = user
	# Пароль пользователя БД 
	database.password = password


6. На новом сервере выполняем команду: 

.. code:: bash

	env/bin/nextgisweb  --config "config.ini" restore "backup/ngwbackup"

7. Запустите NextGIS Web. Должно работать всё, кроме слоёв PostGIS (при их  
   наличии).
8. Если необходимо перенести базу PostGIS с геоданными, то создается новая база 
   данных, в нее разворачивается резервная копия со старого сервера.
9. В настройках подключений PostGIS указывается новый адрес сервера. 

Если появляется ошибка "No module named pysqlite2" - значит при установке вы 
забыли перенести sqlite. Выполните нужную команду из инструкции по установке.



Дополнительное бэкапирование для Compulink
------------------------------------------

В целях увеличения надежности все данные системы бэкапируются стандартными средствами ОС и СУБД.

Скрипт бэкапирования расположен в **/opt/ngw/adm_scripts/do_backup.sh**.
Данный скрипт копирует всю файловую структуру **/opt/ngw** и делает полный слепок БД с помощью утилиты **pg_dumpall**.

Для востановления бэкапа необходимо:
 * выбрать нужную копию бэкапа
 * развернуть вложенный архив **files.tgz** в директорию **/opt/ngw**
 * восстановить БД из вложенного архива **db_all.gz**


.. warning::
   Перед восстановление необходимо сделать копию всех имеющихся данных с помощью скрипка **/opt/ngw/adm_scripts/do_backup.sh**.
